🪙 RefChain Web3 钱包与测试网积分上链升级计划
🎯 目标
在当前 RefChain MVP (Web2) 基础上，增加最基础的 Web3 功能层：
* 商户端接入真实钱包（MetaMask / WalletConnect）

* 使用 Polygon Amoy 测试网 实现真实积分上链（ERC-1155）

* 前端能显示链上地址、链上积分与同步状态

⚙️ 该版本保持结构简洁，仅增加最必要的 Web3 元素，让演示既真实又轻量。
________________


🧩 一、钱包连接 (MetaMask / WalletConnect)
逻辑说明
   1. 商户登录系统后，在 Dashboard 顶部出现 “Connect Wallet” 按钮。

   2. 点击按钮 → 浏览器检测 MetaMask 或 WalletConnect。

   3. 用户授权后返回钱包地址，例如 0x12A3...F9D0。

   4. 系统将此地址显示在页面顶部并写入数据库 (merchants.wallet_address)。

   5. 后续积分上链时使用该地址作为发起者或签名方。

体验效果（前端 UI）
Dashboard 顶部状态栏：
🔗 Connected Wallet: 0x12A3…F9D0


或未连接时：
🟠 Connect Wallet


连接成功后：
      * 按钮变灰、地址缩写显示；

      * 如果钱包切换或断开，UI 自动刷新状态；

      * 没有安装 MetaMask 时提示安装链接。

________________


🔗 二、测试网积分上链逻辑 (Polygon Amoy)
目标网络
         * Network: Polygon Amoy Testnet

         * Chain ID: 80002

         * RPC URL: https://rpc-amoy.polygon.technology

         * Block Explorer: https://amoy.polygonscan.com

         * Gas Token: 测试 MATIC（免费，从 Faucet 获取）

上链流程逻辑
            1. 客户点击推荐链接 → 后端计算应得积分。

            2. 后端先写入数据库（points + point_transactions）。

同时执行合约 mint 操作：

contract.mint(to=customer_wallet, id=merchant_tokenId, amount=points)
               3.                4. 返回交易哈希 txHash 并存入数据库 transaction_hash。

               5. 前端 Dashboard 从后端 API 获取交易状态，展示链上同步信息。

合约说明
使用 contracts/RefChainPoints.sol，遵循 ERC-1155 标准。
商户或系统钱包具有 MINTER_ROLE 权限，可执行积分 mint 操作。
________________


🧠 三、前后端协作逻辑
后端逻辑
引入 ethers.js 并配置环境变量：

POLYGON_AMOY_RPC=https://rpc-amoy.polygon.technology
PRIVATE_KEY=系统钱包私钥 (仅测试用)
CONTRACT_ADDRESS=已部署合约地址
                  1.                   2. 创建 web3/pointsBridge.js：

                     * mintPoints(to, tokenId, amount) 调用合约 mint

                     * 返回 txHash

                        3. 当发放积分时：

                           * 本地写入积分 → 调用 mint → 更新交易哈希 → 标记 onchain_status='synced'

                              4. 提供新接口 /api/points/onchain/:merchantId 供前端查询链上余额。

________________


前端逻辑
                                 1. 使用 wagmi + viem 库集成钱包连接。

                                 2. 在 Dashboard 页面顶部加入钱包状态栏。

                                 3. 用户点击 “Connect Wallet” → MetaMask 弹窗 → 地址展示。

                                 4. 每次刷新时读取数据库保存的钱包地址并自动连接。

                                 5. 通过 wagmi 调用 balanceOf(address, tokenId) 读取链上积分。

                                 6. 对比数据库中的本地积分，展示同步状态。

________________


🧭 四、前端交互展示效果
1️⃣ 钱包连接区（Dashboard 顶部）
Connected Wallet: 0xA23f…E8B1 ✅
Network: Polygon Amoy


若未连接：
🟠 Wallet not connected
[Connect Wallet]


2️⃣ 积分展示区（双数据源）
本地积分: 61 pts
链上积分 (Polygon Amoy): 59 pts ⏳ Pending Sync


几秒后刷新链上余额：
链上积分 (Polygon Amoy): 61 pts ✅ 已同步


3️⃣ 交易状态表
用户
	推荐码
	奖励积分
	状态
	链上交易
	alice@example.com
	refA123
	+50
	✅ Synced
	🔗 0xabc123...
	bob@example.com
	refB456
	+30
	⏳ Pending
	—
	________________


⚙️ 五、主要文件结构（增量）
backend/
├── src/web3/
│   └── pointsBridge.js           # 负责合约交互 (mint, balanceOf)
├── src/routes/
│   └── onchainRoutes.js          # 提供链上查询接口
└── .env                          # RPC、私钥、合约地址


frontend/
├── components/WalletConnect.js   # 钱包连接组件
├── pages/dashboard.js            # 商户端主页 (新增链上积分展示)
├── utils/contractConfig.js       # Polygon Amoy RPC + ABI
└── contracts/RefChainPoints.json # 编译后 ABI 文件


________________


🔄 六、演示脚本（Demo Flow）
1️⃣ 商户登录系统
2️⃣ 点击 “Connect Wallet” → MetaMask 弹窗授权
3️⃣ Dashboard 显示：
Connected Wallet: 0x12A3…F9D0


4️⃣ 用户点击推荐链接 → 系统发放积分
5️⃣ Dashboard 更新：
本地积分: 50 pts
链上积分 (Polygon Amoy): 0 pts ⏳ Pending Sync


6️⃣ 后端完成 mint → Polygon Amoy 上生成交易
7️⃣ 前端刷新后显示：
链上积分 (Polygon Amoy): 50 pts ✅ 已同步


8️⃣ 交易记录区出现 Polygonscan 链接
9️⃣ 点击链接 → 打开真实链上交易页面
________________


🧱 七、开发阶段说明
阶段
	内容
	说明
	阶段 1
	钱包连接与地址保存
	前端连接 MetaMask，写入 merchants 表
	阶段 2
	合约部署
	部署 RefChainPoints.sol 至 Polygon Amoy
	阶段 3
	后端 mint 集成
	调用 mint 函数写入链上积分
	阶段 4
	前端链上积分展示
	调用 balanceOf 对比显示同步状态
	________________


🧾 八、测试网准备指南
1️⃣ 钱包准备
                                    * 安装 MetaMask

                                    * 切换至 Polygon Amoy Testnet

                                    * 从 Faucet 领取测试 MATIC：
 https://faucet.polygon.technology

2️⃣ 部署合约
通过 Hardhat 执行：
npx hardhat run scripts/deploy.js --network amoy


3️⃣ 环境变量设置
POLYGON_AMOY_RPC=https://rpc-amoy.polygon.technology
PRIVATE_KEY=0xYourTestWalletPrivateKey
CONTRACT_ADDRESS=0xYourDeployedContract


________________


💡 九、预期成果
前端演示可视化效果：
                                       * 顶部钱包连接状态 ✅

                                       * 积分栏显示「本地积分 vs 链上积分」✅

                                       * 交易表展示 PolygonScan 链接 ✅

后端功能：
                                          * 商户钱包地址保存 ✅

                                          * 后端调用合约 mint ✅

                                          * 数据库同步链上状态 ✅

最终展示时，观众可看到：
                                             * 钱包真实连接（MetaMask 弹窗）

                                             * Polygon Amoy 上的真实交易哈希

                                             * 本地与链上积分一致的可视化同步效果。